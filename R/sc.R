#' @title sc_10x
#' @description One key to prepare multiple samples of 10x three files
#' @param path working directory
#' @param dir_name_idx Sample name index
#' @param sc_10x_name_idx 10x three files index
#' @param str What to divide it by
#' @return 10x three files
sc_10x = function(path,
                  dir_name_idx = 2,
                  sc_10x_name_idx = 4,
                  str = "_"){
  setwd(path)
  options(warn = -1)
  library(R.utils)
  list_files = list.files()
  list_files = list_files[is_in(".gz",list_files)]
  list_files_sample = unique(strsplit_fromto(list_files,str,dir_name_idx))
  for (sample_name in list_files_sample) {
    dir.create(sample_name, recursive = TRUE, showWarnings = TRUE)
    }
  for (variable in list_files) {
    dir_include = strsplit_fromto(variable,str,2)
    file.copy(from = variable,
              to = paste0(dir_include,"/",variable))
  }
  for (dir_sample in list_files_sample) {
    setwd(paste0(path,"/",dir_sample))
    list_files_sample = list.files()
  for (variable in list_files_sample) {
    gunzip(variable, remove = FALSE, overwrite = TRUE)
    file.remove(variable)
    file.rename(gsub(".gz","",variable),
                strsplit_fromto(gsub(".gz","",variable),str,sc_10x_name_idx))
    file.rename("features.tsv", "genes.tsv")
  }
}
}
#' @title sc_10x_seurat
#' @description One key to Create Seurat Object
#' @param path working directory
#' @param if_join if Join Layers default = TRUE
#' @param min.cells min.cells default = 3
#' @param min.features min.features default = 200
#' @return Seurat Object
sc_10x_seurat = function(path,
                         if_join = TRUE,
                         min.cells = 3,
                         min.features = 200){
  library(Seurat)
  samples = list.dirs(path)[2:length(list.dirs(path))]
  samples = gsub(paste0(path,"/"),"",samples,fixed = TRUE)
  scRNAlist = lapply(samples,function(samples){
    folder = file.path(path,samples)
    sce = CreateSeuratObject(counts = Read10X(folder),
                             project = samples,
                             min.cells = min.cells,
                             min.features = min.features)
    colnames(sce) = paste0(samples,"_",colnames(sce))
    return(sce)
  })
  scRNA = merge(scRNAlist[[1]], scRNAlist[2:length(scRNAlist)])
  if(if_join == FALSE){
    return(scRNA)
  }else{
    scRNA_combined = JoinLayers(scRNA)
    return(scRNA_combined)
  }
}
#' @title sc_qc_mouse
#' @description Seurat Object
#' @param scRNA Seurat Object
#' @param min_Gene min_Gene default = 500
#' @param max_Gene max_Gene default = 4000
#' @param max_UMI max_UMI default = 15000
#' @param pct_mt pct_mt default = 10
#' @param pct_rb pct_rb default = 1
#' @param plot_featrures plot_featrures default = c("nFeature_RNA","nCount_RNA","percent.MT","percent.RB")
#' @param group group default = "orig.ident"
#' @param width width = 28
#' @param height height = 8
#' @param mycolor mycolor
#' @param alphas alphas default = 0.8
#' @return Seurat Object

sc_qc_mouse = function(scRNA,
                       min_Gene = 500,
                       max_Gene = 4000,
                       max_UMI = 15000,
                       pct_MT = 10,
                       pct_RB = 100,
                       plot_featrures = c("nFeature_RNA","nCount_RNA","percent.MT"),
                       group = "orig.ident",
                       width = 28,
                       height = 8,
                       alphas = 0.8,
                       mycolor = c("#BC3C29FF","#0072B5FF","#E18727FF",
                                   "#20854EFF","#7876B1FF","#6F99ADFF",
                                   "#FFDC91FF","#EE4C97FF","#E64B35FF",
                                   "#4DBBD5FF","#00A087FF","#3C5488FF",
                                   "#F39B7FFF","#8491B4FF","#91D1C2FF",
                                   "#DC0000FF","#7E6148FF","#B09C85FF",
                                   "#3B4992FF","#EE0000FF","#008B45FF",
                                   "#631879FF","#008280FF","#BB0021FF",
                                   "#5F559BFF","#A20056FF","#808180FF",
                                   "#00468BFF","#ED0000FF","#42B540FF",
                                   "#0099B4FF","#925E9FFF","#FDAF91FF",
                                   "#AD002AFF","#ADB6B6FF","#374E55FF",
                                   "#DF8F44FF","#00A1D5FF","#B24745FF",
                                   "#79AF97FF","#6A6599FF","#80796BFF",
                                   "#1f77b4",  "#ff7f0e",  "#279e68",
                                   "#d62728",  "#aa40fc",  "#8c564b",
                                   "#e377c2",  "#b5bd61",  "#17becf","#aec7e8")){
  library(ggplot2)
  library(patchwork)
  scRNA[["percent.MT"]] = PercentageFeatureSet(scRNA, pattern = "^mt-")
  scRNA[["percent.RB"]] = PercentageFeatureSet(scRNA, pattern = "^Rp[sl]")

  plots_qc = list()
  for(i in seq_along(plot_featrures)){
    plots_qc[[paste0("before_",i)]] = VlnPlot(scRNA,
                         cols = alpha(mycolor,alphas),
                         group.by = group,
                         pt.size = 0,
                         features = plot_featrures[i]) +
      theme(axis.title.x = element_blank()) +
      NoLegend()
  }

  scRNA = subset(scRNA,
                 subset = percent.MT < pct_MT &
                          nCount_RNA < max_UMI &
                          nFeature_RNA > min_Gene &
                          nFeature_RNA < max_Gene &
                          percent.RB < pct_RB)

  for(i in seq_along(plot_featrures)){
    plots_qc[[paste0("after_",i)]] = VlnPlot(scRNA,
                         cols = alpha(mycolor,alphas),
                         group.by = group,
                         pt.size = 0,
                         features = plot_featrures[i]) +
      theme(axis.title.x=element_blank()) +
      NoLegend()
  }
  violin_qc = wrap_plots(plots = plots_qc, nrow = 2)

  pdf(file = "qc_before_and_after.pdf", width = width, height = height)
  print(violin_qc)
  dev.off()

  return(scRNA)
}
#' @title sc_qc_human
#' @description Seurat Object
#' @param scRNA Seurat Object
#' @param min_Gene min_Gene default = 500
#' @param max_Gene max_Gene default = 4000
#' @param max_UMI max_UMI default = 15000
#' @param pct_mt pct_mt default = 10
#' @param pct_rb pct_rb default = 1
#' @param plot_featrures plot_featrures default = c("nFeature_RNA","nCount_RNA","percent.MT","percent.RB")
#' @param group group default = "orig.ident"
#' @param width width = 28
#' @param height height = 8
#' @param alphas alphas default = 0.8
#' @param mycolor mycolor
#' @return Seurat Object

sc_qc_human = function(scRNA,
                       min_Gene = 500,
                       max_Gene = 4000,
                       max_UMI = 15000,
                       pct_MT = 10,
                       pct_RB = 100,
                       plot_featrures = c("nFeature_RNA","nCount_RNA","percent.MT"),
                       group = "orig.ident",
                       width = 28,
                       height = 8,
                       alphas = 0.8,
                       mycolor = c("#BC3C29FF","#0072B5FF","#E18727FF",
                                   "#20854EFF","#7876B1FF","#6F99ADFF",
                                   "#FFDC91FF","#EE4C97FF","#E64B35FF",
                                   "#4DBBD5FF","#00A087FF","#3C5488FF",
                                   "#F39B7FFF","#8491B4FF","#91D1C2FF",
                                   "#DC0000FF","#7E6148FF","#B09C85FF",
                                   "#3B4992FF","#EE0000FF","#008B45FF",
                                   "#631879FF","#008280FF","#BB0021FF",
                                   "#5F559BFF","#A20056FF","#808180FF",
                                   "#00468BFF","#ED0000FF","#42B540FF",
                                   "#0099B4FF","#925E9FFF","#FDAF91FF",
                                   "#AD002AFF","#ADB6B6FF","#374E55FF",
                                   "#DF8F44FF","#00A1D5FF","#B24745FF",
                                   "#79AF97FF","#6A6599FF","#80796BFF",
                                   "#1f77b4",  "#ff7f0e",  "#279e68",
                                   "#d62728",  "#aa40fc",  "#8c564b",
                                   "#e377c2",  "#b5bd61",  "#17becf","#aec7e8")){
  library(ggplot2)
  library(patchwork)
  scRNA[["percent.MT"]] = PercentageFeatureSet(scRNA, pattern = "^mt-")
  scRNA[["percent.RB"]] = PercentageFeatureSet(scRNA, pattern = "^Rp[sl]")

  plots_qc = list()
  for(i in seq_along(plot_featrures)){
    plots_qc[[paste0("before_",i)]] = VlnPlot(scRNA,
                                              cols = alpha(mycolor,alphas),
                                              group.by = group,
                                              pt.size = 0,
                                              features = plot_featrures[i]) +
      theme(axis.title.x = element_blank()) +
      NoLegend()
  }

  scRNA = subset(scRNA,
                 subset = percent.MT < pct_MT &
                   nCount_RNA < max_UMI &
                   nFeature_RNA > min_Gene &
                   nFeature_RNA < max_Gene &
                   percent.RB < pct_RB)

  for(i in seq_along(plot_featrures)){
    plots_qc[[paste0("after_",i)]] = VlnPlot(scRNA,
                                             cols = alpha(mycolor,alphas),
                                             group.by = group,
                                             pt.size = 0,
                                             features = plot_featrures[i]) +
      theme(axis.title.x=element_blank()) +
      NoLegend()
  }
  violin_qc = wrap_plots(plots = plots_qc, nrow = 2)

  pdf(file = "qc_before_and_after.pdf", width = width, height = height)
  print(violin_qc)
  dev.off()

  return(scRNA)
}

#' @title sc_cellcycle_adjust
#' @description Seurat Object
#' @param scRNA Seurat Object
#' @param is_v5 is v5 Seurat Object default = TRUE
#' @param species species default = human or u use mouse
#' @param width width default = 6
#' @param height height default = 3
#' @param alphas alphas default = 0.8
#' @param mycolor mycolor
#' @return Seurat Object
sc_cellcycle_adjust = function(scRNA,
                            species = "human",
                            is_v5 = TRUE,
                            width = 6,
                            height = 3,
                            alphas = 0.8,
                            mycolor = c("#BC3C29FF","#0072B5FF","#E18727FF",
                                        "#20854EFF","#7876B1FF","#6F99ADFF",
                                        "#FFDC91FF","#EE4C97FF","#E64B35FF",
                                        "#4DBBD5FF","#00A087FF","#3C5488FF",
                                        "#F39B7FFF","#8491B4FF","#91D1C2FF",
                                        "#DC0000FF","#7E6148FF","#B09C85FF",
                                        "#3B4992FF","#EE0000FF","#008B45FF",
                                        "#631879FF","#008280FF","#BB0021FF",
                                        "#5F559BFF","#A20056FF","#808180FF",
                                        "#00468BFF","#ED0000FF","#42B540FF",
                                        "#0099B4FF","#925E9FFF","#FDAF91FF",
                                        "#AD002AFF","#ADB6B6FF","#374E55FF",
                                        "#DF8F44FF","#00A1D5FF","#B24745FF",
                                        "#79AF97FF","#6A6599FF","#80796BFF",
                                        "#1f77b4",  "#ff7f0e",  "#279e68",
                                        "#d62728",  "#aa40fc",  "#8c564b",
                                        "#e377c2",  "#b5bd61",  "#17becf","#aec7e8")){
  library(ggplot2)
  library(patchwork)
  if(is_v5 == TRUE){
  scRNA[["RNA"]] = as(scRNA[["RNA"]], "Assay")
  }
  if(species == "mouse"){
  data("mouse_cell_cycle_genes")
  mouse.s.genes = mouse_cell_cycle_genes[[1]]
  mouse.g2m.genes = mouse_cell_cycle_genes[[2]]
  scRNA = CellCycleScoring(object = scRNA,
                           g2m.features = mouse.g2m.genes,
                           s.features = mouse.s.genes)
  plot_S.Score = VlnPlot(scRNA,
                         features = c("S.Score"),
                         cols = alpha(mycolor,alphas)
                         ) + NoLegend()
  plot_G2M.Score = VlnPlot(scRNA,
                           features = c("G2M.Score"),
                           cols = alpha(mycolor,alphas)
                           ) + NoLegend()

  violin_cellcycle = wrap_plots(plots = list(plot_S.Score,plot_G2M.Score), nrow = 1)
  pdf(file = "sc_cellcycle_adjust_mouse.pdf", width = width, height = height)
  print(violin_cellcycle)
  dev.off()
  }else if(species == "human"){
    scRNA = CellCycleScoring(object = scRNA,
                             g2m.features = cc.genes$g2m.genes,
                             s.features = cc.genes$s.genes)
    plot_S.Score = VlnPlot(scRNA,
                           features = c("S.Score"),
                           cols = alpha(mycolor,alphas)
    ) + NoLegend()
    plot_G2M.Score = VlnPlot(scRNA,
                             features = c("G2M.Score"),
                             cols = alpha(mycolor,alphas)
    ) + NoLegend()
    violin_cellcycle = wrap_plots(plots = list(plot_S.Score,plot_G2M.Score), nrow = 1)
    pdf(file = "sc_cellcycle_adjust_human.pdf", width = width, height = height)
    print(violin_cellcycle)
    dev.off()
  }
  return(scRNA)
}
#' @title sc_scale
#' @description Seurat Object
#' @param scRNA Seurat Object
#' @param methods_my methods_my default = NA, or set as "sct"
#' @param if_vars_to_regress if_vars_to_regress default = "TRUE", or set as "FALSE"
sc_scale = function(scRNA,
                    methods_my = NA,
                    if_vars_to_regress = "TRUE") {
  if(is.na(methods_my)){
    scRNA = NormalizeData(object = scRNA,
                          normalization.method = "LogNormalize",
                          scale.factor = 10000)
    scRNA = FindVariableFeatures(object = scRNA,
                                 selection.method = "vst",
                                 nfeatures = 2000)
    if(if_vars_to_regress == FALSE){
      scRNA = ScaleData(scRNA)
    }else{
      scRNA = ScaleData(scRNA,vars.to.regress = c("S.Score", "G2M.Score"))
    }

  }else if(methods_my == "sct"){
    if(if_vars_to_regress == FALSE){
      scRNA = SCTransform(scRNA)
    }else{
      scRNA = SCTransform(scRNA,vars.to.regress = c("S.Score", "G2M.Score"))
    }
  }
  return(scRNA)
}

#' @title sc_select_pc
#' @description Seurat Object
#' @param scRNA Seurat Object
#' @param npcs npcs default = 20
#' @param width width default = 8
#' @param height height default = 2
sc_select_pc = function(scRNA,
                        npcs = 30,
                        width = 12,
                        height = 3,
                        alphas = 0.8,
                        mycolor = c("#BC3C29FF","#0072B5FF","#E18727FF",
                                    "#20854EFF","#7876B1FF","#6F99ADFF",
                                    "#FFDC91FF","#EE4C97FF","#E64B35FF",
                                    "#4DBBD5FF","#00A087FF","#3C5488FF",
                                    "#F39B7FFF","#8491B4FF","#91D1C2FF",
                                    "#DC0000FF","#7E6148FF","#B09C85FF",
                                    "#3B4992FF","#EE0000FF","#008B45FF",
                                    "#631879FF","#008280FF","#BB0021FF",
                                    "#5F559BFF","#A20056FF","#808180FF",
                                    "#00468BFF","#ED0000FF","#42B540FF",
                                    "#0099B4FF","#925E9FFF","#FDAF91FF",
                                    "#AD002AFF","#ADB6B6FF","#374E55FF",
                                    "#DF8F44FF","#00A1D5FF","#B24745FF",
                                    "#79AF97FF","#6A6599FF","#80796BFF",
                                    "#1f77b4",  "#ff7f0e",  "#279e68",
                                    "#d62728",  "#aa40fc",  "#8c564b",
                                    "#e377c2",  "#b5bd61",  "#17becf","#aec7e8")) {
  library(ggplot2)
  library(patchwork)
  scRNA = RunPCA(scRNA,
                 npcs = npcs,
                 pc.genes = VariableFeatures(object = scRNA),
                 verbose = FALSE)
  plot_Variable = VariableFeaturePlot(object = scRNA)+ NoLegend()
  plot_Variable_top = LabelPoints(plot = plot_Variable,
                       points = head(x = VariableFeatures(object = scRNA), 3),
                       repel = TRUE) + NoLegend()
  plot_DimPlot = DimPlot(object = scRNA, reduction = "pca",cols = alpha(mycolor,alphas))
  plot_ElbowPlot = ElbowPlot(scRNA,ndims = npcs)

  plot_RunPCA = wrap_plots(plots = list(plot_Variable,
                                        plot_Variable_top,
                                        plot_DimPlot,
                                        plot_ElbowPlot), nrow = 1)
  pdf(file = "sc_RunPCA.pdf", width = width, height = height)
  print(plot_RunPCA)
  dev.off()
  # Determine percent of variation associated with each PC
  pct = scRNA[["pca"]]@stdev / sum(scRNA[["pca"]]@stdev) * 100
  # Calculate cumulative percents for each PC
  cumu = cumsum(pct)
  # Determine which PC exhibits cumulative percent greater than 90% and % variation associated with the PC as less than 5
  co1 = which(cumu > 90 & pct < 5)[1]
  # Determine the difference between variation of PC and subsequent PC，last point where change of % of variation is more than 0.1
  co2 = sort(which((pct[1:length(pct) - 1] - pct[2:length(pct)]) > 0.1), decreasing = T)[1] + 1
  # Max of the two calculation
  pc_select = max(co1, co2)
  print(pc_select)

  scRNA = RunPCA(scRNA,
                 npcs = pc_select,
                 pc.genes = VariableFeatures(object = scRNA),
                 verbose = FALSE)
  return(scRNA)
}
